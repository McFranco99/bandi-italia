<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üáÆüáπ Bandi Italia - Aggregatore Nazionale</title>
    <style>
        /* ...tutto il CSS originale lasciato invariato... */
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <div class="logo">üáÆüáπ Bandi Italia</div>
        <div style="font-size: 12px; color: var(--color-text-secondary);">
            Ultimo aggiornamento: <span id="lastUpdate">Caricamento...</span>
        </div>
    </div>
</header>

<div class="container">
    <!-- Status Banner -->
    <div id="statusBanner" class="status-banner success" style="display: none;">
        <span id="statusIcon">‚úì</span>
        <span id="statusMessage">Connesso all'API</span>
    </div>

    <!-- Filtri -->
    <div class="filters">
        <h3 style="margin-bottom: 16px;">üîç Cerca Bandi</h3>
        <div class="filter-row">
            <div class="form-group">
                <label>Categoria</label>
                <select id="filterCategoria">
                    <option value="">Tutte le categorie</option>
                    <option value="lavoro">Lavoro e Concorsi</option>
                    <option value="imprese">Imprese e Innovazione</option>
                    <option value="immobili">Immobili e Aste</option>
                    <option value="investimenti">Investimenti e Startup</option>
                </select>
            </div>
            <div class="form-group">
                <label>Regione</label>
                <select id="filterRegione">
                    <option value="">Tutte le regioni</option>
                    <option value="nazionale">Nazionale</option>
                    <option value="lombardia">Lombardia</option>
                    <option value="lazio">Lazio</option>
                    <option value="veneto">Veneto</option>
                    <option value="piemonte">Piemonte</option>
                    <option value="toscana">Toscana</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fonte</label>
                <select id="filterFonte">
                    <option value="">Tutte le fonti</option>
                    <option value="InPA">InPA</option>
                    <option value="Gazzetta">Gazzetta</option>
                    <option value="Invitalia">Invitalia</option>
                    <option value="MIMIT">MIMIT</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ricerca testuale</label>
                <input type="text" id="searchText" placeholder="Cerca per titolo o descrizione..." />
            </div>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="applicaFiltri()">Cerca</button>
            <button class="btn btn-secondary" onclick="resetFiltri()">Reset</button>
        </div>
    </div>

    <!-- Statistiche -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="statTotale">0</div>
            <div class="stat-label">Bandi Trovati</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statAperti">0</div>
            <div class="stat-label">Bandi Aperti</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statScadenza">0</div>
            <div class="stat-label">In Scadenza</div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <div>Caricamento bandi in corso...</div>
    </div>

    <!-- Lista Bandi -->
    <div id="bandiContainer" class="bandi-grid" style="display: none;"></div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üì≠</div>
        <h3>Nessun bando trovato</h3>
        <p>Prova a modificare i filtri di ricerca</p>
    </div>
</div>

<script>
    const API_URL = 'https://web-production-a261.up.railway.app/api/bandi';
    const STATS_URL = 'https://web-production-a261.up.railway.app/api/stats';

    let tuttiBandi = [];
    let bandiFiltrati = [];

    async function caricaBandi() {
        try {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('bandiContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('API non disponibile');

            const data = await response.json();
            tuttiBandi = data.bandi || [];
            bandiFiltrati = [...tuttiBandi];

            // Aggiorna timestamp
            if (data.ultimo_aggiornamento) {
                const date = new Date(data.ultimo_aggiornamento);
                document.getElementById('lastUpdate').textContent = date.toLocaleString('it-IT');
            }

            mostraStatus('success', `‚úì ${tuttiBandi.length} bandi caricati dall'API`);

            caricaStatistiche();
            mostraBandi();
        } catch (error) {
            console.error('Errore caricamento bandi:', error);
            mostraStatus('error', "‚úó Errore connessione API. Verifica che la tua API sia attiva online.");
            document.getElementById('loadingState').style.display = 'none';
        }
    }

    async function caricaStatistiche() {
        try {
            const response = await fetch(STATS_URL);
            const data = await response.json();

            if (data.success) {
                document.getElementById('statTotale').textContent = data.stats.totale;
                document.getElementById('statAperti').textContent = data.stats.aperti;
                document.getElementById('statScadenza').textContent = data.stats.in_scadenza;
            }
        } catch (error) {
            console.error('Errore caricamento statistiche:', error);
        }
    }

    function mostraStatus(tipo, messaggio) {
        const banner = document.getElementById('statusBanner');
        const icon = document.getElementById('statusIcon');
        const message = document.getElementById('statusMessage');

        banner.className = `status-banner ${tipo}`;
        icon.textContent = tipo === 'success' ? '‚úì' : '‚úó';
        message.textContent = messaggio;
        banner.style.display = 'flex';
    }

    function mostraBandi() {
        const container = document.getElementById('bandiContainer');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');

        loadingState.style.display = 'none';

        if (bandiFiltrati.length === 0) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        container.style.display = 'grid';
        container.innerHTML = '';

        bandiFiltrati.forEach(bando => {
            const card = creaBandoCard(bando);
            container.appendChild(card);
        });
    }

    function creaBandoCard(bando) {
        const card = document.createElement('div');
        card.className = 'bando-card';

        const categoria = bando.category || 'altro';
        const regione = bando.region || 'N/D';
        const scadenza = bando.deadline ? new Date(bando.deadline).toLocaleDateString('it-IT') : 'N/D';
        const fonte = bando.source || bando.entity || 'N/D';

        const colorMap = {
            'InPA': '#0d6efd',
            'Gazzetta': '#198754',
            'Invitalia': '#ffc107',
            'MIMIT': '#dc3545'
        };
        const badgeColor = colorMap[fonte] || '#6c757d';

        card.innerHTML = `
            <div class="bando-header">
                <div>
                    <div class="bando-title">${bando.title || bando.titolo || 'Bando senza titolo'}</div>
                    <div class="bando-meta">
                        <span class="badge badge-category">${tradCategoria(categoria)}</span>
                        <span class="badge badge-region">${regione}</span>
                        <span class="badge badge-status">Scadenza: ${scadenza}</span>
                        <span class="badge" style="background-color:${badgeColor};color:white;">${fonte}</span>
                    </div>
                </div>
            </div>
            <div class="bando-description">
                ${(bando.description || bando.descrizione || 'Nessuna descrizione disponibile').substring(0, 200)}...
            </div>
            <div class="bando-footer">
                <div style="font-size: 12px; color: var(--color-text-secondary);">
                    Fonte dettagliata: ${fonte}
                </div>
                <a href="${bando.url}" target="_blank" class="bando-link">Vedi dettagli ‚Üí</a>
            </div>
        `;

        return card;
    }

    function tradCategoria(cat) {
        const map = {
            'lavoro': 'Lavoro',
            'imprese': 'Imprese',
            'immobili': 'Immobili',
            'investimenti': 'Investimenti'
        };
        return map[cat] || cat;
    }

    function applicaFiltri() {
        const categoria = document.getElementById('filterCategoria').value;
        const regione = document.getElementById('filterRegione').value;
        const fonte = document.getElementById('filterFonte').value;
        const searchText = document.getElementById('searchText').value.toLowerCase();

        bandiFiltrati = tuttiBandi.filter(bando => {
            if (categoria && bando.category !== categoria) return false;
            if (regione && bando.region !== regione && bando.region !== 'nazionale') return false;
            if (fonte && bando.source !== fonte) return false;
            if (searchText) {
                const title = (bando.title || bando.titolo || '').toLowerCase();
                const desc = (bando.description || bando.descrizione || '').toLowerCase();
                if (!title.includes(searchText) && !desc.includes(searchText)) return false;
            }
            return true;
        });

        mostraBandi();
    }

    function resetFiltri() {
        document.getElementById('filterCategoria').value = '';
        document.getElementById('filterRegione').value = '';
        document.getElementById('filterFonte').value = '';
        document.getElementById('searchText').value = '';
        bandiFiltrati = [...tuttiBandi];
        mostraBandi();
    }

    // Auto-refresh ogni 5 minuti
    setInterval(caricaBandi, 5 * 60 * 1000);

    // Carica al caricamento pagina
    window.addEventListener('DOMContentLoaded', caricaBandi);
</script>
</body>
</html>
